#! /usr/bin/env bash

set -Eeuo pipefail

cargo install --force honggfuzz

if [ -d hfuzz_workspace/ ]; then
    rm -r hfuzz_workspace/
fi

builderr=0
for TARGET in tests/fuzz/*; do
    FILE="$(basename $TARGET)"
    FILE="${FILE%.*}"
    git checkout HEAD Cargo.toml
    echo -e "\n# $0: BEGIN OF AUTOGENERATED\n[[bin]]\nname = \"$FILE\"\npath = \"$TARGET\"\n# $0: END OF AUTOGENERATED SECTION" >> Cargo.toml
    if [ -d "hfuzz_input/$FILE/" ]; then
        HFUZZ_INPUT_ARGS="-f ${target%/*}/$FILE/input"
    fi

    set +e
    HFUZZ_BUILD_ARGS="" \
    HFUZZ_RUN_ARGS="-N1000000 --exit_upon_crash ${HFUZZ_INPUT_ARGS:+-v} ${HFUZZ_INPUT_ARGS:-}" \
    cargo hfuzz run "$FILE"
    if [ "$?" -ne 0 ]; then
        builderr="$((builderr + 1))"
    fi
    set -e
    HFUZZ_INPUT_ARGS=
done

if [ "$builderr" -gt 0 ]; then
    echo "$builderr fuzzing tests failed building"
fi

found=0
for TARGET in tests/fuzz/*; do
    FILE="$(basename $TARGET)"
    FILE="${FILE%.*}"
    report="hfuzz_workspace/$FILE/HONGGFUZZ.REPORT.TXT"
    if [ -f "$report" ]; then
        cat "$report"
        for CASE in "hfuzz_workspace/$FILE/SIG"*; do
            cat "$CASE" | xxd -p
        done
        found="$((found + 1))"
    fi
done

if [ "$found" -gt 0 ]; then
    echo "$found fuzzing tests found errors"
fi

if [ "$builderr" -gt 0 ] || [ "$found" -gt 0 ]; then
    exit 1
fi

echo "All fuzzing tests passed"
